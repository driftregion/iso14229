name: unit tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: lint
      run: CHECK_FORMAT=1 ./tools/run_clang_format.sh
      continue-on-error: true

    - name: Install build deps & can-utils
      run: |
        sudo apt-get update
        # Pull extras that contain vcan.ko (and can-isotp.ko on many kernels)
        sudo apt-get install -y "linux-modules-extra-$(uname -r)" || \
          sudo apt-get install -y linux-modules-extra-azure
        sudo apt-get install -y can-utils

    - name: Enable SocketCAN + ISO-TP (with fallback)
      shell: bash
      run: |
        set -euxo pipefail

        sudo apt-get update
        # Try distro-provided modules first (sometimes contains vcan/isotp)
        sudo apt-get install -y "linux-modules-extra-$(uname -r)" || true

        # Core CAN + vcan
        sudo modprobe can || true
        sudo modprobe can_raw || true
        sudo modprobe vcan || true
        sudo ip link add dev vcan0 type vcan || true
        sudo ip link set vcan0 up
        ip -details link show vcan0

        # Try loading ISO-TP; if missing, build it
        if ! sudo modprobe can-isotp 2>/dev/null; then
          echo "can-isotp not packaged for $(uname -r); building out-of-tree..."
          sudo apt-get install -y git build-essential "linux-headers-$(uname -r)"
          git clone --depth=1 https://github.com/hartkopp/can-isotp
          make -C can-isotp
          # Install so modprobe can find it, refresh module deps, then load
          sudo make -C can-isotp modules_install
          sudo depmod -a
          sudo modprobe can-isotp
        fi

        lsmod | egrep 'can_isotp|vcan' || true

    - name: run unit tests
      run: bazel test //test:all --test_output=errors

    - name: run coverage
      run: |
        bazel coverage \
        --combined_report=lcov \
        --instrumentation_filter='^//:(iso14229)$' \
        --experimental_collect_code_coverage_for_generated_files \
        //test:test_client_tp_mock \
        //test:test_server_tp_mock \
        //test:test_tp_isotp_compliance_mock \
        //test:test_tp_isotp_compliance_c \
        //test:test_tp_isotp_compliance_sock
        cp $(bazel info output_path)/_coverage/_coverage_report.dat coverage.lcov
        sed -E -i 's#^SF:bazel-out/.*/iso14229.c#SF:iso14229.c#' coverage.lcov
        sed -E -i 's#^SF:bazel-out/.*/iso14229.h#SF:iso14229.h#' coverage.lcov
        ls -l coverage.lcov
    
    - name: upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: coverage.lcov          # point directly at the Bazel LCOV
        disable_search: true          # donâ€™t look for anything else
        name: iso14229-coverage
        fail_ci_if_error: true
        token: ${{ secrets.CODECOV_TOKEN }}
    
    - name: run ultra_strict
      run: bazel build --config=x86_64_clang //test:ultra_strict
    
  build-windows:
    runs-on: windows-latest

    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: run unit tests
      run: bazel test //test:all --verbose_failures --test_output=all 


  build-arduino:
    runs-on: ubuntu-latest

    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: Install Arduino CLI
      uses: arduino/setup-arduino-cli@v2

    - name: build
      run: |
        arduino-cli core install arduino:samd
        arduino-cli lib install CAN
        arduino-cli -b arduino:samd:mkrwifi1010 compile examples/arduino_server/main 


  build-esp32:
    runs-on: ubuntu-latest

    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: esp-idf build
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.2
        target: esp32
        path: 'examples/esp32_server'